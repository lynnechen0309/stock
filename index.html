<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dividend Vibe - 配息小幫手</title>
    
    <!-- iOS Web App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #fbcfe8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f472b6;
        }
        
        /* Prevent pull-to-refresh on mobile to improve drag experience */
        body {
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-[#FFF5F7]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            query, 
            orderBy, 
            serverTimestamp,
            updateDoc,
            writeBatch
        } from 'firebase/firestore';
        import { 
            Plus, 
            Calendar, 
            DollarSign, 
            TrendingUp, 
            Trash2, 
            ChevronRight, 
            PieChart, 
            Wallet,
            Check,
            X,
            Search,
            Sparkles,
            History,
            ChevronDown,
            ChevronUp,
            LayoutGrid,
            List,
            Target,
            Edit3,
            GripVertical
        } from 'lucide-react';

        // --- Firebase Configuration & Initialization ---
        // 使用您提供的設定
        const firebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'dividend-vibe'; // 預設 App ID

        // --- Stock Database (Popular TW Stocks & ETFs) ---
        const STOCK_DB = {
            '00878': '國泰永續高股息',
            '0056': '元大高股息',
            '00929': '復華台灣科技優息',
            '00919': '群益台灣精選高息',
            '00940': '元大台灣價值高息',
            '0050': '元大台灣50',
            '006208': '富邦台50',
            '00713': '元大台灣高息低波',
            '00939': '統一台灣高息動能',
            '00915': '凱基優選高股息30',
            '00679B': '元大美債20年',
            '00687B': '國泰20年美債',
            '2330': '台積電',
            '2317': '鴻海',
            '2454': '聯發科',
            '2412': '中華電',
            '2303': '聯電',
            '2881': '富邦金',
            '2882': '國泰金',
            '2884': '玉山金',
            '2886': '兆豐金',
            '2891': '中信金',
            '2892': '第一金',
            '5880': '合庫金',
            '2880': '華南金',
            '2885': '元大金',
            '1101': '台泥',
            '1102': '亞泥',
            '2002': '中鋼',
            '2603': '長榮',
            '2609': '陽明',
            '2615': '萬海'
        };

        // --- Components ---

        // 1. Month Selector Component (Soft Pink Style)
        const MonthSelector = ({ selectedMonths, onChange }) => {
            const months = [
                '1月', '2月', '3月', '4月', '5月', '6月', 
                '7月', '8月', '9月', '10月', '11月', '12月'
            ];

            const toggleMonth = (index) => {
                if (selectedMonths.includes(index)) {
                onChange(selectedMonths.filter(m => m !== index));
                } else {
                onChange([...selectedMonths, index].sort((a, b) => a - b));
                }
            };

            return (
                <div className="grid grid-cols-4 gap-3 mt-3">
                {months.map((m, idx) => (
                    <button
                    key={idx}
                    type="button"
                    onClick={() => toggleMonth(idx + 1)}
                    className={`text-xs font-medium py-2.5 rounded-xl transition-all duration-300 border ${
                        selectedMonths.includes(idx + 1)
                        ? 'bg-pink-400 text-white border-pink-400 shadow-lg shadow-pink-200 scale-105'
                        : 'bg-pink-50/50 text-slate-400 border-transparent hover:bg-pink-50 hover:text-pink-400'
                    }`}
                    >
                    {m}
                    </button>
                ))}
                </div>
            );
        };

        // 2. History Group Component
        const HistoryGroup = ({ group, onDelete }) => {
            const [isExpanded, setIsExpanded] = useState(false);

            return (
                <div className="bg-white rounded-2xl border border-pink-50 shadow-[0_4px_20px_rgb(255,192,203,0.1)] overflow-hidden transition-all duration-300 hover:shadow-[0_8px_30px_rgb(255,182,193,0.15)]">
                <button 
                    onClick={() => setIsExpanded(!isExpanded)}
                    className="w-full flex justify-between items-center p-5 bg-white hover:bg-pink-50/30 transition-colors"
                >
                    <div className="flex items-center gap-4">
                    <div className={`h-10 w-10 rounded-full flex items-center justify-center transition-colors ${isExpanded ? 'bg-pink-100 text-pink-500' : 'bg-slate-50 text-slate-400'}`}>
                        <DollarSign size={20} />
                    </div>
                    <div className="text-left">
                        <h4 className="font-bold text-slate-700 text-lg group-hover:text-pink-500 transition-colors">{group.name}</h4>
                        <p className="text-xs text-slate-400 font-medium tracking-wide">{group.symbol} • {group.items.length} 筆紀錄</p>
                    </div>
                    </div>
                    <div className="text-right flex items-center gap-4">
                    <div>
                        <p className="text-[10px] text-pink-300 uppercase font-bold tracking-widest mb-0.5">累計</p>
                        <p className="text-lg font-bold text-pink-500 font-mono tracking-tight">${group.total.toLocaleString()}</p>
                    </div>
                    {isExpanded ? <ChevronUp size={20} className="text-pink-300" /> : <ChevronDown size={20} className="text-slate-300" />}
                    </div>
                </button>

                {isExpanded && (
                    <div className="bg-pink-50/30 border-t border-pink-100 px-5 py-2 space-y-1 animate-in slide-in-from-top-2 duration-200">
                    {group.items.map((record, idx) => (
                        <div key={record.id} className="flex justify-between items-center py-3 border-b border-pink-100/50 last:border-0 group">
                        <div className="flex items-center gap-3">
                            <div className="h-1.5 w-1.5 rounded-full bg-pink-200 group-hover:bg-pink-400 transition-colors"></div>
                            <span className="text-sm text-slate-600 font-medium font-mono">{record.date}</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-sm font-bold text-pink-500 font-mono">+${record.amount.toLocaleString()}</span>
                            <button 
                            onClick={(e) => { e.stopPropagation(); onDelete(record.id); }}
                            className="text-pink-200 hover:text-red-400 hover:bg-white p-1.5 rounded-lg transition-all"
                            >
                            <Trash2 size={14} />
                            </button>
                        </div>
                        </div>
                    ))}
                    </div>
                )}
                </div>
            );
        };

        // 3. Main Application
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard'); // 'dashboard' | 'add' (edit) | 'list' | 'history'
            const [stocks, setStocks] = useState([]);
            const [records, setRecords] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Form State (Add / Edit)
            const [isEditing, setIsEditing] = useState(false);
            const [currentStockId, setCurrentStockId] = useState(null);
            const [newStock, setNewStock] = useState({
                symbol: '',
                name: '',
                frequency: 'quarterly', // monthly, quarterly, semiannual, annual
                months: []
            });
            const [autoFillAnimation, setAutoFillAnimation] = useState(false);

            // Record Modal State
            const [recordingStock, setRecordingStock] = useState(null);
            const [recordAmount, setRecordAmount] = useState('');
            const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);

            // Drag & Drop State
            const [draggedItem, setDraggedItem] = useState(null);
            const [localStocks, setLocalStocks] = useState([]); // For optimistic UI updates during drag
            const dragItemRef = useRef(null);
            const dragOverItemRef = useRef(null);

            // --- Icon Setup (iOS Home Screen & Favicon) ---
            useEffect(() => {
                const iconUrl = '123.jpg'; // 請確保此圖片與 html 在同一目錄
                
                // 設定 Apple Touch Icon
                let appleLink = document.querySelector("link[rel='apple-touch-icon']");
                if (!appleLink) {
                    appleLink = document.createElement('link');
                    appleLink.rel = 'apple-touch-icon';
                    document.head.appendChild(appleLink);
                }
                appleLink.href = iconUrl;

                // 設定 Favicon
                let favLink = document.querySelector("link[rel~='icon']");
                if (!favLink) {
                    favLink = document.createElement('link');
                    favLink.rel = 'icon';
                    document.head.appendChild(favLink);
                }
                favLink.href = iconUrl;
            }, []);

            // --- Auth & Data Effects ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // 在單一檔案環境通常沒有 __initial_auth_token，直接使用匿名登入
                        console.log("Signing in anonymously...");
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;

                // Fetch Stocks ordered by 'order'
                const qStocks = query(collection(db, 'artifacts', appId, 'users', user.uid, 'stocks'), orderBy('order', 'asc'));
                const unsubStocks = onSnapshot(qStocks, (snapshot) => {
                const fetchedStocks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setStocks(fetchedStocks);
                setLocalStocks(fetchedStocks);
                setLoading(false);
                }, (err) => console.error("Stocks error", err));

                // Fetch Records
                const qRecords = query(collection(db, 'artifacts', appId, 'users', user.uid, 'records'), orderBy('date', 'desc'));
                const unsubRecords = onSnapshot(qRecords, (snapshot) => {
                setRecords(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => console.error("Records error", err));

                return () => {
                unsubStocks();
                unsubRecords();
                };
            }, [user]);

            // --- Auto-Fill Logic ---
            useEffect(() => {
                if (view !== 'add') return;
                const foundName = STOCK_DB[newStock.symbol];
                if (foundName && (!newStock.name || Object.values(STOCK_DB).includes(newStock.name))) {
                setNewStock(prev => ({ ...prev, name: foundName }));
                setAutoFillAnimation(true);
                setTimeout(() => setAutoFillAnimation(false), 1000);
                }
            }, [newStock.symbol, view]);

            // --- Logic Helpers ---

            const handleFrequencyChange = (freq) => {
                let suggestedMonths = [];
                if (freq === 'monthly') suggestedMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
                if (freq === 'quarterly') suggestedMonths = [1, 4, 7, 10]; 
                if (freq === 'semiannual') suggestedMonths = [6, 12];
                if (freq === 'annual') suggestedMonths = [8]; 

                setNewStock({ ...newStock, frequency: freq, months: suggestedMonths });
            };

            const handleSaveStock = async (e) => {
                e.preventDefault();
                if (!user || !newStock.symbol || !newStock.name) return;

                try {
                if (isEditing && currentStockId) {
                    // Update existing
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', currentStockId), {
                    ...newStock,
                    updatedAt: serverTimestamp()
                    });
                } else {
                    // Add new (append to end)
                    const order = stocks.length > 0 ? (stocks[stocks.length - 1].order || 0) + 1 : 0;
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stocks'), {
                    ...newStock,
                    order: order,
                    createdAt: serverTimestamp()
                    });
                }
                resetForm();
                setView('list'); // Return to list view to see changes
                } catch (error) {
                console.error("Error saving stock:", error);
                }
            };

            const deleteStock = async (id) => {
                if(!confirm('確定要刪除這檔股票嗎？相關紀錄將保留，但不再顯示於日曆。')) return;
                try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', id));
                } catch (error) {
                console.error("Error deleting stock:", error);
                }
            };

            const deleteRecord = async (id) => {
                if(!confirm('確定要刪除這筆領息紀錄嗎？金額將從總資產中扣除。')) return;
                try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'records', id));
                } catch (error) {
                console.error("Error deleting record:", error);
                }
            };

            const saveRecord = async (e) => {
                e.preventDefault();
                if (!user || !recordingStock || !recordAmount) return;

                try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'records'), {
                    stockId: recordingStock.id,
                    stockName: recordingStock.name,
                    symbol: recordingStock.symbol,
                    amount: parseFloat(recordAmount),
                    date: recordDate,
                    createdAt: serverTimestamp()
                });
                setRecordingStock(null);
                setRecordAmount('');
                } catch (error) {
                console.error("Error saving record:", error);
                }
            };

            const openAddModal = () => {
                resetForm();
                setView('add');
            };

            const openEditModal = (stock) => {
                setIsEditing(true);
                setCurrentStockId(stock.id);
                setNewStock({
                symbol: stock.symbol,
                name: stock.name,
                frequency: stock.frequency || 'quarterly',
                months: stock.months || []
                });
                setView('add');
            };

            const resetForm = () => {
                setIsEditing(false);
                setCurrentStockId(null);
                setNewStock({ symbol: '', name: '', frequency: 'quarterly', months: [] });
            };

            // --- Drag & Drop Logic (Touch + Mouse) ---
            const handleDragStart = (e, index) => {
                dragItemRef.current = index;
                setDraggedItem(localStocks[index]);
                if (e.dataTransfer) {
                e.dataTransfer.effectAllowed = "move";
                }
            };

            const handleDragEnter = (e, index) => {
                dragOverItemRef.current = index;
                const dragIndex = dragItemRef.current;
                
                if (dragIndex === null || dragIndex === index) return;

                // Optimistic Reordering
                const newItems = [...localStocks];
                const draggedItemContent = newItems[dragIndex];
                newItems.splice(dragIndex, 1);
                newItems.splice(index, 0, draggedItemContent);
                
                dragItemRef.current = index; // Update reference for continuous dragging
                setLocalStocks(newItems);
            };

            const handleDragEnd = async () => {
                setDraggedItem(null);
                dragItemRef.current = null;
                dragOverItemRef.current = null;

                // Persist new order to Firestore
                if (!user) return;
                try {
                const batch = writeBatch(db);
                localStocks.forEach((stock, index) => {
                    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', stock.id);
                    batch.update(ref, { order: index });
                });
                await batch.commit();
                } catch (error) {
                console.error("Error updating order:", error);
                }
            };

            // Touch Drag Logic
            const [touchStartPos, setTouchStartPos] = useState(null);
            
            const handleTouchStart = (e, index) => {
                dragItemRef.current = index;
                setTouchStartPos(e.touches[0].clientY);
                setDraggedItem(localStocks[index]);
                document.body.style.overflow = 'hidden';
            };

            const handleTouchMove = (e) => {
                if (dragItemRef.current === null) return;
                const touchY = e.touches[0].clientY;
                
                // Find element below touch
                const element = document.elementFromPoint(e.touches[0].clientX, touchY);
                if (!element) return;
                
                const listItem = element.closest('[data-index]');
                if (listItem) {
                const targetIndex = parseInt(listItem.getAttribute('data-index'));
                if (targetIndex !== dragItemRef.current && !isNaN(targetIndex)) {
                    // Swap
                    const newItems = [...localStocks];
                    const [removed] = newItems.splice(dragItemRef.current, 1);
                    newItems.splice(targetIndex, 0, removed);
                    setLocalStocks(newItems);
                    dragItemRef.current = targetIndex;
                }
                }
            };

            const handleTouchEnd = () => {
                document.body.style.overflow = '';
                handleDragEnd();
            };


            // --- Computed Stats ---
            const totalDividends = useMemo(() => {
                return records.reduce((sum, r) => sum + (r.amount || 0), 0);
            }, [records]);

            const calendarData = useMemo(() => {
                const data = {};
                for (let i = 1; i <= 12; i++) data[i] = [];
                stocks.forEach(stock => {
                if (stock.months && Array.isArray(stock.months)) {
                    stock.months.forEach(m => {
                    if (data[m]) data[m].push(stock);
                    });
                }
                });
                return data;
            }, [stocks]);

            const historyData = useMemo(() => {
                const grouped = {};
                records.forEach(r => {
                const key = r.stockId || r.symbol; 
                if (!grouped[key]) {
                    grouped[key] = {
                    id: key,
                    name: r.stockName,
                    symbol: r.symbol,
                    total: 0,
                    items: []
                    };
                }
                grouped[key].total += (r.amount || 0);
                grouped[key].items.push(r);
                });
                return Object.values(grouped).sort((a, b) => b.total - a.total);
            }, [records]);

            const monthNames = [
                "一月", "二月", "三月", "四月", "五月", "六月",
                "七月", "八月", "九月", "十月", "十一月", "十二月"
            ];

            // --- Render ---
            if (loading) {
                return (
                <div className="min-h-screen bg-[#FFF5F7] flex items-center justify-center">
                    <div className="flex flex-col items-center">
                    <div className="h-12 w-12 border-4 border-pink-200 border-t-pink-400 rounded-full animate-spin mb-4"></div>
                    <p className="text-pink-300 text-sm font-medium tracking-wide">載入中...</p>
                    </div>
                </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#FFF5F7] text-slate-700 font-sans selection:bg-pink-100 selection:text-pink-600 pb-28">
                
                {/* 1. Header */}
                <div className="bg-white/70 backdrop-blur-md sticky top-0 z-20 border-b border-pink-100">
                    <div className="max-w-2xl mx-auto px-6 py-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2.5">
                        <div className="bg-gradient-to-tr from-pink-400 to-rose-300 p-2.5 rounded-xl text-white shadow-lg shadow-pink-200">
                            <TrendingUp size={20} />
                        </div>
                        <div>
                            <h1 className="font-bold text-lg leading-none text-slate-800">Dividend Vibe</h1>
                            <p className="text-[10px] text-pink-300 font-bold tracking-[0.2em] mt-1">配息小幫手</p>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>

                <div className="max-w-2xl mx-auto px-6 mt-8">
                    
                    {/* Navigation */}
                    <div className="bg-white/60 p-1.5 rounded-2xl flex gap-1 mb-8 backdrop-blur-sm border border-pink-100 shadow-sm">
                    {[
                        { id: 'dashboard', icon: LayoutGrid, label: '日曆總覽' },
                        { id: 'history', icon: History, label: '領息紀錄' },
                        { id: 'list', icon: List, label: '庫存管理' },
                    ].map(tab => (
                        <button
                        key={tab.id}
                        onClick={() => { setView(tab.id); resetForm(); }}
                        className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 ${
                            view === tab.id 
                            ? 'bg-white text-pink-500 shadow-md shadow-pink-100 scale-[1.02] border border-pink-50' 
                            : 'text-slate-400 hover:text-pink-400 hover:bg-white/50'
                        }`}
                        >
                        <tab.icon size={16} strokeWidth={2.5} className={view === tab.id ? 'text-pink-400' : 'opacity-40'} />
                        {tab.label}
                        </button>
                    ))}
                    </div>

                    {/* View: Dashboard */}
                    {view === 'dashboard' && (
                    <div className="animate-in fade-in slide-in-from-bottom-8 duration-500 space-y-6">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {monthNames.map((mName, idx) => {
                            const monthNum = idx + 1;
                            const monthStocks = calendarData[monthNum];
                            const isCurrentMonth = new Date().getMonth() + 1 === monthNum;

                            return (
                            <div 
                                key={monthNum} 
                                className={`relative rounded-3xl p-5 border transition-all duration-300 ${
                                isCurrentMonth 
                                ? 'bg-white border-pink-300 shadow-[0_0_0_4px_rgba(251,113,133,0.1)]' 
                                : 'bg-white border-white shadow-sm hover:shadow-md hover:border-pink-100 hover:shadow-pink-100/50'
                                }`}
                            >
                                <div className="flex justify-between items-center mb-4">
                                <h3 className={`text-lg font-bold tracking-tight ${isCurrentMonth ? 'text-pink-500' : 'text-slate-600'}`}>{mName}</h3>
                                {isCurrentMonth && (
                                    <span className="flex h-2 w-2">
                                    <span className="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-pink-300 opacity-75"></span>
                                    <span className="relative inline-flex rounded-full h-2 w-2 bg-pink-400"></span>
                                    </span>
                                )}
                                </div>
                                
                                <div className="space-y-2 min-h-[40px]">
                                {monthStocks.length === 0 ? (
                                    <div className="h-full flex items-center justify-start">
                                    <span className="text-slate-300 text-xs font-medium italic">無配息</span>
                                    </div>
                                ) : (
                                    monthStocks.map(stock => (
                                    <div 
                                        key={stock.id} 
                                        onClick={() => setRecordingStock(stock)}
                                        className="group flex items-center justify-between bg-pink-50/50 hover:bg-pink-50 px-3 py-2.5 rounded-xl cursor-pointer transition-all border border-transparent hover:border-pink-100 active:scale-95"
                                    >
                                        <div className="flex items-center gap-2.5">
                                        <span className="bg-white text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-pink-100 font-mono font-bold group-hover:border-pink-200 group-hover:text-pink-500">{stock.symbol}</span>
                                        <span className="text-sm font-bold text-slate-600 group-hover:text-pink-600">{stock.name}</span>
                                        </div>
                                        <div className="bg-white p-1 rounded-md text-pink-200 shadow-sm border border-pink-50 group-hover:text-pink-400 group-hover:border-pink-100 transition-colors">
                                        <Plus size={12} strokeWidth={3} />
                                        </div>
                                    </div>
                                    ))
                                )}
                                </div>
                            </div>
                            );
                        })}
                        </div>
                        
                        <div className="bg-gradient-to-r from-pink-50 to-rose-50 p-5 rounded-3xl border border-pink-100 flex gap-4 items-center shadow-sm">
                        <div className="bg-white p-3 rounded-2xl shadow-sm text-pink-400">
                            <Target size={24} />
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-700 text-sm">想要紀錄收入？</h4>
                            <p className="text-xs text-slate-500/80 mt-1">
                                直接點擊日曆上的股票卡片，即可快速紀錄每一次的實際配息金額。
                            </p>
                        </div>
                        </div>
                    </div>
                    )}

                    {/* View: History */}
                    {view === 'history' && (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-8">
                        <div className="bg-slate-800 rounded-3xl p-6 text-white shadow-2xl shadow-pink-200/50 relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-pink-400/30 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-pink-400/40 transition-all duration-700"></div>
                            <div className="absolute bottom-0 left-0 w-48 h-48 bg-rose-300/20 rounded-full blur-2xl translate-y-1/2 -translate-x-1/3 group-hover:bg-rose-300/30 transition-all duration-700"></div>
                            <div className="relative z-10">
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Total Dividends</p>
                            <div className="flex items-baseline gap-1">
                                <span className="text-2xl opacity-60 font-medium">$</span>
                                <h2 className="text-4xl font-bold font-mono tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-pink-200">
                                {totalDividends.toLocaleString()}
                                </h2>
                            </div>
                            <div className="mt-6 flex items-center gap-2 text-xs font-medium text-pink-100 bg-white/10 w-fit px-3 py-1.5 rounded-full backdrop-blur-md border border-white/5">
                                <Sparkles size={12} className="text-pink-300" />
                                <span>累積被動收入</span>
                            </div>
                            </div>
                        </div>

                        {historyData.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-10 text-slate-400">
                            <div className="bg-white p-6 rounded-full mb-4 shadow-sm border border-pink-100">
                                <History size={40} className="text-pink-200" />
                            </div>
                            <p className="font-medium text-slate-500">尚未有任何領息紀錄</p>
                            <p className="text-xs text-slate-400 mt-2">快去日曆上點擊股票紀錄第一筆收入吧！</p>
                        </div>
                        ) : (
                        <div className="space-y-4">
                            {historyData.map(group => (
                                <HistoryGroup key={group.id} group={group} onDelete={deleteRecord} />
                            ))}
                        </div>
                        )}
                    </div>
                    )}

                    {/* View: Stock List (Editable & Sortable) */}
                    {view === 'list' && (
                    <div className="space-y-3 animate-in fade-in slide-in-from-bottom-8 pb-10">
                        <div className="flex items-center justify-between mb-2 px-1">
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">長按把手可拖曳排序 • 點擊編輯</p>
                        </div>
                        
                        {localStocks.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                            <div className="bg-white p-6 rounded-full mb-4 shadow-sm border border-pink-100">
                                <Wallet size={40} className="text-pink-200" />
                            </div>
                            <p className="font-medium text-slate-500">您尚未加入任何股票</p>
                            <button onClick={openAddModal} className="mt-4 text-pink-500 font-bold hover:underline">立即新增</button>
                        </div>
                        ) : (
                        localStocks.map((stock, index) => (
                            <div 
                            key={stock.id} 
                            data-index={index}
                            onDragStart={(e) => handleDragStart(e, index)}
                            onDragEnter={(e) => handleDragEnter(e, index)}
                            onDragEnd={handleDragEnd}
                            onDragOver={(e) => e.preventDefault()}
                            draggable
                            className={`bg-white p-4 rounded-2xl border flex justify-between items-center group transition-all select-none
                                ${draggedItem?.id === stock.id ? 'opacity-40 border-pink-300 scale-95 shadow-inner bg-pink-50' : 'border-pink-50 shadow-[0_2px_10px_rgb(255,192,203,0.05)] hover:shadow-md hover:border-pink-100'}
                            `}
                            >
                                <div className="flex items-center gap-3 flex-1">
                                {/* Drag Handle */}
                                <div 
                                    className="cursor-grab active:cursor-grabbing text-slate-300 hover:text-pink-400 p-1 touch-none"
                                    onTouchStart={(e) => handleTouchStart(e, index)}
                                    onTouchMove={handleTouchMove}
                                    onTouchEnd={handleTouchEnd}
                                >
                                    <GripVertical size={20} />
                                </div>

                                <div 
                                    onClick={() => openEditModal(stock)}
                                    className="flex items-center gap-3 flex-1 cursor-pointer"
                                >
                                    <div className="h-10 w-10 bg-pink-50 text-slate-500 rounded-xl flex items-center justify-center font-bold font-mono text-sm border border-pink-50 group-hover:bg-pink-100 group-hover:text-pink-500 group-hover:border-pink-200 transition-colors">
                                    {stock.symbol}
                                    </div>
                                    <div>
                                    <h4 className="font-bold text-slate-700 text-lg group-hover:text-pink-600 transition-colors">{stock.name}</h4>
                                    <div className="flex flex-wrap gap-1 mt-1.5">
                                        {stock.months && stock.months.sort((a,b)=>a-b).map(m => (
                                        <span key={m} className="text-[10px] bg-slate-50 text-slate-400 px-2 py-0.5 rounded-md font-medium group-hover:bg-pink-50 group-hover:text-pink-400 transition-colors">
                                            {m}月
                                        </span>
                                        ))}
                                    </div>
                                    </div>
                                </div>
                                </div>

                                <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => openEditModal(stock)}
                                    className="p-2 text-slate-300 hover:text-pink-500 hover:bg-pink-50 rounded-xl transition-all"
                                >
                                    <Edit3 size={18} />
                                </button>
                                <button 
                                    onClick={() => deleteStock(stock.id)}
                                    className="p-2 text-slate-300 hover:text-red-400 hover:bg-red-50 rounded-xl transition-all"
                                >
                                    <Trash2 size={18} />
                                </button>
                                </div>
                            </div>
                        ))
                        )}
                    </div>
                    )}

                </div>

                {/* FAB */}
                {view !== 'add' && (
                    <button
                    onClick={openAddModal}
                    className="fixed bottom-8 right-8 bg-slate-800 text-white p-4 rounded-full shadow-xl shadow-pink-300/50 hover:bg-pink-500 hover:scale-110 active:scale-95 transition-all duration-300 z-30 group"
                    >
                    <Plus size={28} className="group-hover:rotate-90 transition-transform duration-300" />
                    </button>
                )}

                {/* Add / Edit Stock Modal */}
                {view === 'add' && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm animate-in fade-in duration-300" onClick={() => setView('list')}></div>
                    <div className="bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8 relative z-10 animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 border border-white/50">
                        <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 tracking-tight">
                                {isEditing ? '編輯股票' : '新增觀察股票'}
                            </h2>
                            <p className="text-slate-400 text-sm mt-1">
                                {isEditing ? '修改您的投資標的設定' : '建立您的被動收入來源'}
                            </p>
                        </div>
                        <button onClick={() => setView('list')} className="p-2 bg-slate-50 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                            <X size={20} />
                        </button>
                        </div>
                        
                        <form onSubmit={handleSaveStock} className="space-y-6">
                        <div className="grid grid-cols-3 gap-4">
                            <div className="col-span-1">
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 pl-1">代號</label>
                                <div className="relative">
                                <input 
                                    type="text" 
                                    placeholder="00878"
                                    className="w-full bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-pink-300 focus:bg-white transition-all font-mono font-bold text-lg text-slate-700"
                                    value={newStock.symbol}
                                    onChange={(e) => setNewStock({...newStock, symbol: e.target.value})}
                                    required
                                />
                                {autoFillAnimation && (
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 text-pink-400 animate-pulse">
                                    <Sparkles size={18} />
                                    </div>
                                )}
                                </div>
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 pl-1">名稱</label>
                                <input 
                                type="text" 
                                placeholder="自動帶入或手動輸入"
                                className={`w-full border border-slate-100 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-pink-300 transition-all font-bold text-lg ${autoFillAnimation ? 'bg-pink-50 text-pink-500 border-pink-100' : 'bg-slate-50 text-slate-700'}`}
                                value={newStock.name}
                                onChange={(e) => setNewStock({...newStock, name: e.target.value})}
                                required
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 pl-1">配息頻率</label>
                            <div className="grid grid-cols-4 gap-2">
                            {[
                                { val: 'monthly', label: '月配' },
                                { val: 'quarterly', label: '季配' },
                                { val: 'semiannual', label: '半年' },
                                { val: 'annual', label: '年配' }
                            ].map(f => (
                                <button
                                key={f.val}
                                type="button"
                                onClick={() => handleFrequencyChange(f.val)}
                                className={`py-3 text-sm font-bold rounded-xl border transition-all duration-200 ${
                                    newStock.frequency === f.val 
                                    ? 'bg-slate-700 text-white border-slate-700 shadow-lg scale-[1.02]' 
                                    : 'bg-white text-slate-400 border-slate-100 hover:border-pink-200 hover:bg-pink-50 hover:text-pink-400'
                                }`}
                                >
                                {f.label}
                                </button>
                            ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 pl-1">入帳月份 (可微調)</label>
                            <MonthSelector 
                            selectedMonths={newStock.months} 
                            onChange={(months) => setNewStock({...newStock, months})}
                            />
                        </div>

                        <button 
                            type="submit" 
                            className="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white font-bold py-4 rounded-2xl shadow-xl shadow-pink-200 hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all mt-4 text-lg"
                        >
                            {isEditing ? '更新設定' : '加入投資組合'}
                        </button>
                        </form>
                    </div>
                    </div>
                )}

                {/* Record Dividend Modal */}
                {recordingStock && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-md animate-in fade-in duration-200" onClick={() => setRecordingStock(null)}></div>
                    <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 relative z-10 animate-in zoom-in-95 duration-200 transform border border-white/50">
                        <div className="flex justify-between items-start mb-6">
                        <div>
                            <h3 className="text-xl font-bold text-slate-800">紀錄配息</h3>
                            <p className="text-sm font-medium text-slate-400 mt-1">
                            {recordingStock.name} ({recordingStock.symbol})
                            </p>
                        </div>
                        <button 
                            onClick={() => setRecordingStock(null)}
                            className="bg-slate-50 p-2 rounded-full text-slate-400 hover:bg-slate-100 transition-colors"
                        >
                            <X size={18} />
                        </button>
                        </div>
                        
                        <form onSubmit={saveRecord}>
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 pl-1">入帳日期</label>
                            <input 
                            type="date" 
                            value={recordDate}
                            onChange={(e) => setRecordDate(e.target.value)}
                            className="w-full bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-pink-300 focus:border-pink-300 outline-none text-slate-600"
                            required
                            />
                        </div>
                        <div className="mb-8 relative">
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 pl-1">實領金額</label>
                            <div className="relative">
                            <span className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 font-bold text-xl">$</span>
                            <input 
                                type="number" 
                                value={recordAmount}
                                onChange={(e) => setRecordAmount(e.target.value)}
                                placeholder="0"
                                className="w-full bg-slate-50 border border-slate-100 rounded-2xl pl-10 pr-6 py-4 text-3xl font-bold text-slate-700 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition-all placeholder:text-slate-300"
                                autoFocus
                                required
                            />
                            </div>
                        </div>
                        
                        <button 
                            type="submit" 
                            className="w-full bg-emerald-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-100 hover:bg-emerald-500 hover:shadow-xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 text-lg"
                        >
                            <Check size={20} strokeWidth={3} /> 
                            確認入帳
                        </button>
                        </form>
                    </div>
                    </div>
                )}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
